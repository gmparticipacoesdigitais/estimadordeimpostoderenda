<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimador de Isenção de Imposto de Renda 2024</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-input {
            @apply w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow;
        }
        .form-label {
            @apply block mb-2 text-sm font-medium text-gray-700;
        }
        .info-icon {
            cursor: pointer;
            display: inline-block;
            margin-left: 8px;
            position: relative;
        }
        .tooltip {
            visibility: hidden;
            width: 220px;
            background-color: #334155;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: 400;
        }
        .info-icon:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex flex-col items-center justify-center p-4">
    <!-- Header com logout -->
    <div class="w-full max-w-4xl mb-4 flex justify-end">
        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm font-medium">
            Sair
        </button>
    </div>

    <main class="bg-white w-full max-w-4xl rounded-2xl shadow-xl p-6 md:p-10 my-8">
        <!-- Cabeçalho da Aplicação -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Estimador de Isenção de Imposto de Renda</h1>
            <p class="text-gray-500 mt-2">Veja se suas deduções podem te levar à faixa de isenção do Imposto de Renda.</p>
            <p class="mt-2 text-sm font-semibold text-indigo-600">Baseado na Tabela Progressiva Mais Recente</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Coluna Esquerda: Campos de Entrada do Usuário -->
            <div class="space-y-6">
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 border-b-2 border-blue-200 pb-2 mb-4">Seus Dados Mensais</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="rendaBruta" class="form-label">Renda Bruta Mensal (R$)</label>
                            <input type="number" id="rendaBruta" class="form-input" placeholder="Ex: 5500.00" step="0.01" min="0">
                        </div>
                        <div>
                            <label for="dependentes" class="form-label">Número de Dependentes</label>
                            <input type="number" id="dependentes" class="form-input" placeholder="Ex: 2" step="1" min="0" value="0">
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-semibold text-gray-700 border-b-2 border-blue-200 pb-2 mb-4">Estimativa de Deduções mensais</h2>
                     <p class="text-sm text-gray-500 mb-4">Informe seus gastos mensais que podem ser deduzidos.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="pensaoAlimenticia" class="form-label">Pensão Alimentícia Judicial (R$)</label>
                            <input type="number" id="pensaoAlimenticia" class="form-input" placeholder="0.00" step="0.01" min="0" value="0">
                        </div>
                        <div>
                            <label for="despesasMedicas" class="form-label">Despesas Médicas (R$)</label>
                            <input type="number" id="despesasMedicas" class="form-input" placeholder="0.00" step="0.01" min="0" value="0">
                        </div>
                        <div>
                            <label for="despesasEducacao" class="form-label">
                                Despesas com Educação (R$)
                                <span class="info-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    <span class="tooltip">A dedução anual é limitada. Este campo ajuda a estimar a redução na base de cálculo mensal.</span>
                                </span>
                            </label>
                            <input type="number" id="despesasEducacao" class="form-input" placeholder="0.00" step="0.01" min="0" value="0">
                        </div>
                         <div>
                            <label for="previdenciaPrivada" class="form-label">
                                Previdência Privada (PGBL) (R$)
                                <span class="info-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    <span class="tooltip">Limitado a 12% da sua renda bruta anual. A simulação usará o limite mensal equivalente.</span>
                                </span>
                            </label>
                            <input type="number" id="previdenciaPrivada" class="form-input" placeholder="0.00" step="0.01" min="0" value="0">
                        </div>
                    </div>
                </div>

                <button id="calculateBtn" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-opacity transform hover:scale-101 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                    Analisar Minha Situação
                </button>
            </div>

            <!-- Coluna Direita: Exibição dos Resultados -->
            <div id="resultado" class="bg-gray-50 rounded-lg p-6 space-y-4 hidden">
                 <div class="text-center py-10">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 class="mt-2 text-lg font-medium text-gray-900">Seu resultado aparecerá aqui</h3>
                    <p class="mt-1 text-sm text-gray-500">Preencha os campos ao lado e clique para calcular.</p>
                </div>
            </div>
        </div>

        <!-- Seção de Avisos Legais -->
        <div class="mt-10 pt-6 border-t border-gray-200">
            <div class="bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-4 rounded-r-lg" role="alert">
                <h3 class="font-bold text-lg">Atenção: Entenda a Obrigatoriedade de Declaração</h3>
                <p class="mt-2 text-sm">Esta é uma simulação de <strong class="font-semibold">cálculo mensal</strong> do imposto. Mesmo que o resultado seja "isento de pagamento", você pode ser <strong class="font-semibold">obrigado(a) a entregar a Declaração de Ajuste Anual (DIRPF)</strong> se, no ano-calendário, você se enquadrar em qualquer uma das seguintes situações (valores referência DIRPF 2024 / ano 2023):</p>
                <ul class="mt-3 list-disc list-inside space-y-1 text-sm">
                    <li>Recebeu rendimentos tributáveis (salários, aluguéis) cuja soma foi superior a <strong>R$ 30.639,90</strong>.</li>
                    <li>Recebeu rendimentos isentos, não tributáveis ou tributados exclusivamente na fonte (FGTS, herança, etc.) cuja soma foi superior a <strong>R$ 200.000,00</strong>.</li>
                    <li>Tinha, em 31 de dezembro, a posse ou a propriedade de bens ou direitos, de valor total superior a <strong>R$ 800.000,00</strong>.</li>
                    <li>Obteve ganho de capital na alienação de bens ou direitos.</li>
                    <li>Realizou operações em bolsas de valores, de mercadorias, de futuros e assemelhadas.</li>
                </ul>
                <p class="mt-4 text-xs font-semibold">AVISO LEGAL: Esta ferramenta é para fins educacionais e de estimativa, não substituindo a orientação de um contador ou profissional de finanças.</p>
            </div>
        </div>
    </main>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        // Verificar autenticação ao carregar a página
        window.addEventListener('load', () => {
            if (!isAuthenticated()) {
                window.location.href = 'login.html';
            }
        });

        const calculateBtn = document.getElementById('calculateBtn');
        const resultadoDiv = document.getElementById('resultado');

        // --- CONSTANTES TRIBUTÁRIAS (Vigência: FEV/2024) ---
        const DEDUCAO_DEPENDENTE = 189.59;
        const LIMITE_ISENCAO_IRPF = 2428.80;

        const TABELA_INSS_2024 = [
            { limite: 1412.00, aliquota: 0.075, deducao: 0 },
            { limite: 2666.68, aliquota: 0.09,  deducao: 21.18 },
            { limite: 4000.03, aliquota: 0.12,  deducao: 101.18 },
            { limite: 7786.02, aliquota: 0.14,  deducao: 181.18 },
            { limite: Infinity, aliquota: 0,   deducao: 908.85 }
        ];

        const TABELA_IRPF_ATUAL = [
            { limite: 2428.80, aliquota: 0,     deducao: 0 },
            { limite: 2826.65, aliquota: 0.075, deducao: 182.16 },
            { limite: 3751.05, aliquota: 0.15,  deducao: 394.16 },
            { limite: 4664.68, aliquota: 0.225, deducao: 675.49 },
            { limite: Infinity, aliquota: 0.275, deducao: 908.73 }
        ];

        // --- FUNÇÕES UTILITÁRIAS ---
        function getNumericValue(id) {
            return parseFloat(document.getElementById(id).value) || 0;
        }

        function formatCurrency(value) {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // --- FUNÇÕES DE CÁLCULO ---
        function calcularINSS(rendaBruta) {
            if (rendaBruta > TABELA_INSS_2024[3].limite) {
                return TABELA_INSS_2024[4].deducao;
            }
            for (const faixa of TABELA_INSS_2024) {
                if (rendaBruta <= faixa.limite) {
                    return (rendaBruta * faixa.aliquota) - faixa.deducao;
                }
            }
            return 0;
        }

        function calcularIRPF(baseCalculo) {
            if (baseCalculo <= 0) return 0;
            
            for (const faixa of TABELA_IRPF_ATUAL) {
                if (baseCalculo <= faixa.limite) {
                    return Math.max(0, (baseCalculo * faixa.aliquota) - faixa.deducao);
                }
            }
            return 0;
        }

        // --- FUNÇÃO PRINCIPAL DE ORQUESTRAÇÃO ---
        function analisarSituacao() {
            const rendaBruta = getNumericValue('rendaBruta');
            if (rendaBruta <= 0) {
                resultadoDiv.innerHTML = `
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg" role="alert">
                        <p class="font-bold">Atenção</p>
                        <p>Por favor, informe uma Renda Bruta Mensal válida para iniciar a simulação.</p>
                    </div>`;
                resultadoDiv.classList.remove('hidden');
                return;
            }

            const dependentes = getNumericValue('dependentes');
            const pensaoAlimenticia = getNumericValue('pensaoAlimenticia');
            const despesasMedicas = getNumericValue('despesasMedicas');
            const despesasEducacao = getNumericValue('despesasEducacao');
            const previdenciaPrivadaInput = getNumericValue('previdenciaPrivada');

            const inss = calcularINSS(rendaBruta);
            const deducaoDependentes = dependentes * DEDUCAO_DEPENDENTE;

            const limitePGBL = rendaBruta * 0.12;
            const previdenciaDedutivel = Math.min(previdenciaPrivadaInput, limitePGBL);
            const pgblExcedeu = previdenciaPrivadaInput > limitePGBL;

            const outrasDeducoes = pensaoAlimenticia + despesasMedicas + despesasEducacao + previdenciaDedutivel;
            const totalDeducoes = inss + deducaoDependentes + outrasDeducoes;

            const baseCalculo = Math.max(0, rendaBruta - totalDeducoes);
            const impostoDevido = calcularIRPF(baseCalculo);

            exibirResultado({
                rendaBruta, inss, deducaoDependentes,
                outrasDeducoesItens: { pensaoAlimenticia, despesasMedicas, despesasEducacao, previdenciaDedutivel },
                pgblExcedeu, limitePGBL, totalDeducoes, baseCalculo, impostoDevido
            });
        }

        // --- FUNÇÃO DE RENDERIZAÇÃO DO RESULTADO ---
        function exibirResultado(data) {
            const isento = data.baseCalculo <= LIMITE_ISENCAO_IRPF;
            let html = '';

            const statusClass = isento ? 'bg-green-100 border-green-500 text-green-800' : 'bg-orange-100 border-orange-500 text-orange-800';
            const statusIcon = isento
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
            const statusTitle = isento ? 'Cenário de Isenção Atingido!' : 'Cenário Tributável';
            const statusMessage = isento
                ? `Com base nas suas deduções, sua base de cálculo ficou <strong class="font-semibold">dentro do limite de isenção</strong> (${formatCurrency(LIMITE_ISENCAO_IRPF)}).`
                : `Sua base de cálculo <strong class="font-semibold">ultrapassou o limite de isenção</strong>. Veja os detalhes abaixo.`;

            html += `
                <div class="border-l-4 p-4 rounded-r-lg ${statusClass}">
                    <div class="flex items-center space-x-3">
                        ${statusIcon}
                        <div>
                            <h3 class="text-xl font-bold">${statusTitle}</h3>
                            <p class="text-sm mt-1">${statusMessage}</p>
                        </div>
                    </div>
                </div>
                
                <h3 class="text-lg font-semibold text-gray-800 pt-4">Demonstrativo de Cálculo</h3>
                <div class="text-sm space-y-2 text-gray-600">
                    <div class="flex justify-between items-center py-2 border-b">
                        <span>Renda Bruta Mensal</span>
                        <span class="font-semibold text-gray-900">${formatCurrency(data.rendaBruta)}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b">
                        <span>(-) Contribuição INSS</span>
                        <span class="font-semibold text-red-600">-${formatCurrency(data.inss)}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b">
                        <span>(-) Dependentes</span>
                        <span class="font-semibold text-red-600">-${formatCurrency(data.deducaoDependentes)}</span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                        <span>(-) Outras Deduções</span>
                        <span class="font-semibold text-red-600">-${formatCurrency(data.outrasDeducoesItens.pensaoAlimenticia + data.outrasDeducoesItens.despesasMedicas + data.outrasDeducoesItens.despesasEducacao + data.outrasDeducoesItens.previdenciaDedutivel)}</span>
                    </div>`;

            if (data.pgblExcedeu) {
                html += `
                    <div class="text-xs text-yellow-700 bg-yellow-100 p-2 rounded-md ml-4">
                        *Sua dedução de Previdência Privada (PGBL) foi limitada a 12% da renda: ${formatCurrency(data.limitePGBL)}.
                    </div>`;
            }
            
            html += `
                    <div class="flex justify-between items-center py-3 border-t-2 border-gray-300 mt-2">
                        <span class="font-bold text-gray-800">(=) Base de Cálculo do IRPF</span>
                        <span class="font-bold text-lg text-blue-700">${formatCurrency(data.baseCalculo)}</span>
                    </div>
                </div>
            `;

            if (!isento) {
                const valorFaltante = data.baseCalculo - LIMITE_ISENCAO_IRPF;
                html += `
                    <div class="mt-4 bg-gray-100 p-4 rounded-lg text-center">
                        <p class="text-sm text-gray-700">Para atingir a isenção, você precisaria de mais <strong class="font-semibold text-indigo-600">${formatCurrency(valorFaltante)}</strong> em deduções mensais.</p>
                        <hr class="my-3">
                        <p class="text-sm text-gray-800 font-semibold">Imposto Mensal Devido (Estimativa):</p>
                        <p class="text-2xl font-bold text-red-600">${formatCurrency(data.impostoDevido)}</p>
                    </div>
                `;
            } else {
                html += `
                    <div class="mt-4 bg-gray-100 p-4 rounded-lg text-center">
                        <p class="text-sm text-gray-800 font-semibold">Imposto Mensal Devido (Estimativa):</p>
                        <p class="text-2xl font-bold text-green-600">${formatCurrency(data.impostoDevido)}</p>
                    </div>
                `;
            }

            resultadoDiv.innerHTML = html;
            resultadoDiv.classList.remove('hidden');
            resultadoDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        calculateBtn.addEventListener('click', analisarSituacao);
    </script>
</body>
</html>
